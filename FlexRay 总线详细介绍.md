#### 文章目录 

 *  [前言][Link 1]
 *  [一、FlexRay简介][FlexRay]
 *   *  [1.1 什么是FlexRay?][1.1 _FlexRay]
     *  [1.2 为什么要FlexRay？][1.2 _FlexRay]
     *  [1.3 FlexRay的特点][1.3 FlexRay]
 *  [二、FlexRay协议介绍][FlexRay 1]
 *   *  [2.1 FlexRay物理结构][2.1 FlexRay]
     *  [2.2 FlexRay拓扑结构][2.2 FlexRay]
     *  [2.3 帧结构][2.3]
     *   *  [2.3.1 起始段][2.3.1]
         *  [2.3.2 有效负载段][2.3.2]
         *  [2.3.3 结束段][2.3.3]
     *  [2.4 编解码][2.4]
     *   *  [2.4.1 静态帧编码][2.4.1]
         *  [2.4.2 动态帧编码][2.4.2]
     *  [2.5 通讯][2.5]
 *  [三、总结][Link 2]

## 前言 

前面已经介绍了CAN、CAN FD、LIN总线，本文介绍一下Flex Ray总线

## 一、FlexRay简介 

### 1.1 什么是FlexRay? 

FlexRay是一种用于汽车的高速、可确定性的，具备故障容错能力的总线技术，它将事件触发和时间触发两种方式结合起来，具有高效的网络利用率和系统灵活性的特点。FlexRay能满足传统的CAN方案不能满足的汽车线控系统（X-by-Wire）的要求。

![pic_0283b070.png](https://mark.cuckooing.cn/pics/pic_0283b070.png)

车载总线的成本和传输速率关系

### 1.2 为什么要FlexRay？ 

常用的车载总线技术 CAN、 LIN 等由于缺少同步性， 确定性及容错性等并不能满足汽车行业未来的需要， 更不能满足汽车线控系统（X-by-Wire） 的要求。于是，宝马和戴姆勒克莱斯勒联合飞利浦和摩托罗拉成立了 FlexRay 联盟。该联盟致力于推广 FlexRay 通信系统在全球的采用， 使其成为高级动力总成、 底盘、 线控系统的标准协议。

其具体任务为制定 FlexRay 需求定义、 开发 FlexRay协议、 定义数据链路层、 提供支持 FlexRay 的控制器、 开发 FlexRay 物理层规范并实现基础解决方案。

主要用于线控操作，如，线控操作转向、防抱死制动系统(ABS)包括车辆稳定控制(VSC)和车辆稳定助手（VSA)等。

FlexRay联盟在2013年发布了ISO 17458标准规范。

第一款采用FlexRay的量产车于2006年在BMW X5中推出，应用在电子控制减震系统中。

### 1.3 FlexRay的特点 

1.  高传输速率：FlexRay的每个信道具有10Mbps带宽。它不仅可以像CAN和LIN总线这样的单信道系统运行，而且还可以作为一个双信道系统运行，因此可以达到20Mbps的最大传输速率，是当前CAN最高运行速率的20倍；
2.  同步时基：FlexRay中使用的访问方法是基于同步时基的。该时基通过协议自动建立和同步，并提供给应用。时基的精确度介于0.5μs和10μs之间（通常为1～2μs）；
3.  确定性：通信是在不断循环的周期中进行的，特定消息在通信周期中拥有固定位置，因此接收器已经提前知道了消息到达的时间。到达时间的临时偏差幅度会非常小，并能得到保证；
4.  高容错性：强大的错误检测性能和容错功能是FlexRay设计时考虑的重要方面。FlexRay总线使用循环冗余校验CRC(Cyclic redundancy cheek)来检验通信中的差错。FlexRay总线通过双通道通信，能够提供冗余功能，并且使用星型拓扑可完全解决容错问题；
5.  灵活性：在FlexRay协议的开发过程中，主要关注的是灵活性，反映在如下几个方面:

>  *  支持多种方式的网络拓扑结构；
>  *  消息长度可配置：可根据实际控制应用需求，为其设定相应的数据载荷长度；
>  *  使用双通道拓扑时，既可用以增加带宽，也可用于传输冗余的消息；
>  *  周期内静态、动态消息传输部分的时间都可随具体应用而定。

1.  可靠性：在汽车要求的工作环境下可靠工作，体现在下面几个方面：

>  *  满足汽车使用的温度环境要求 在不使用外部滤波器条件下 每个FlexRay产品满足汽车系统和法规要求的EMC指标。
>  *  直接与线束相连的总线控制器和通信控制器的输入/输出，满足汽车上电器系统的要求

## 二、FlexRay协议介绍 

### 2.1 FlexRay物理结构 

FlexRay总线和CAN 一样也是两根线，可采用屏蔽或不屏蔽的双绞线，每个通道有两根导线，即总线正（Bus-Plus，BP）和总线负（Bus-Minus，BM）组成。采用不归零法（NRZ,Non-Return to Zero）进行编码。

可通过测量BP和BM之间的电压差来判断总线状态，这样可减少外部干扰对总线信息的影响，因为当干扰同时作用在两根导线上时可相互抵消。

每个通道都需使用80~110欧的终端电阻。将不同的电压加载在一个通道的两根导线上，可使总线有四种状态：Idle\_Lp（Low power）、Idle、Data\_0 和 Data\_1

![pic_25a57ade.png](https://mark.cuckooing.cn/pics/pic_25a57ade.png)

显性：差分电压不为0V（Data\_0和Data\_1）

隐性：差分电压为0V（Idle\_Lp、Idle）

### 2.2 FlexRay拓扑结构 

FlexRay的拓扑有3种：线型(点对点、多节点)、星型和混合型三大类。

![pic_fcec361b.png](https://mark.cuckooing.cn/pics/pic_fcec361b.png)

点对点的线型结构

![pic_a9010008.png](https://mark.cuckooing.cn/pics/pic_a9010008.png)

多节点的线型结构

星型结构的优势：

>  *  它在接收器和发送器之间提供点到点连接。该优势在高传输速率和长传输线路中尤为明显。
>  *  另一个重要优势是错误分离功能。例如，如果信号传输使用的两条线路短路，总线系统在该信道不能进行进一步的通信。

使用星状结构， 则只有到连接短路的节点才会受到影响， 其它所有节点仍然可以继续与其它节点通信  
![pic_76c72049.png](https://mark.cuckooing.cn/pics/pic_76c72049.png)

星型线型结构

![pic_c7fe15ae.png](https://mark.cuckooing.cn/pics/pic_c7fe15ae.png)

混合型结构

### 2.3 帧结构 

FlexRay帧由起始段、有效负载段和结束段三大部分构成。  
![pic_2fe192d9.png](https://mark.cuckooing.cn/pics/pic_2fe192d9.png)

#### 2.3.1 起始段 

![pic_c05927d0.png](https://mark.cuckooing.cn/pics/pic_c05927d0.png)  
起始段长 5 个字节（40 位），包括： 状态位(5 位)，帧 ID(11 位)，有效载荷长度(7 位)，头部 CRC(11 位)，循环计数(6 位)。

状态位：

>  *  保留位(1 位)：为以后的扩展使用
>  *  净荷指示位(1 位)：Payload Preamble Indicator 指明负载段的向量信息
>  *  空帧指示位(1 位)：Null Frame Indicator-表示该帧是否为无效帧
>  *  同步帧指示位(1 位)：Sync Frame Indicator-表示该帧是否为一个同步帧
>  *  起始帧指示位(1 位)：Startup Frame Indicator-表示该帧是否为起始帧

帧ID：数据标志符，每个通道数据标志符需唯一。用于对事件触发帧进行优先级排序

有效载荷长度：表示一帧中能传输的有效数据长度。  
在每个Cycle下的静态区中，每帧的数据长度是相同的，在动态区的长度则是不同的。

头部 CRC：用于起始段冗余校验，检查传输中的错误。

周期计数：循环计数器，通信一开始， 所有节点的周期计数器增 1。

#### 2.3.2 有效负载段 

![pic_8d3f6d92.png](https://mark.cuckooing.cn/pics/pic_8d3f6d92.png)  
有效载荷包含帧传输的实际数据。FlexRay 有效数据帧的长度最多为 127 个字（254 字节），比 CAN 长 30 多倍

#### 2.3.3 结束段 

包含三个用于检测错误的 8 位 CRC，由起始段和有效负载段计算得出的CRC校验码，计算CRC时，根据网络传输顺序从保留位到有效负载段的最后一位放到CRC生成器中进行计算  
![pic_c3083162.png](https://mark.cuckooing.cn/pics/pic_c3083162.png)

### 2.4 编解码 

编码的过程实际上就是对要发送的数据进行相应的“打包”处理，如加上各种校验位、 ID等。编码与解码主要发生在通讯控制器与总线驱动器之间，如下图所示：

![pic_4bbb1032.png](https://mark.cuckooing.cn/pics/pic_4bbb1032.png)

其中 RxD 位接收信号， TxD 为发送信号， TxEN 为通讯控制器请求数据信号。信息的二进制表示采用“不归零”码。对于双通道的节点， 每个通道上的编码与解码的过程是同时完成的

#### 2.4.1 静态帧编码 

![pic_8cbabc3e.png](https://mark.cuckooing.cn/pics/pic_8cbabc3e.png)

静态帧编码

TSS(传输启动序列)：用于初始化节点和网络通信的对接， 为一小段低电平。

FSS(帧启动序列)：用来补偿 TSS 后第一个字节可能出现的量化误差， 为一位的高电平

BSS(字节启动序列)：给接受节点提供数据定时信息， 由一位高电平和一位低电平组成。

FES(帧结束序列)：用来标识数据帧最后一个字节序列结束， 由一位低电平和一位高电平组成。

#### 2.4.2 动态帧编码 

![pic_4d7969ab.png](https://mark.cuckooing.cn/pics/pic_4d7969ab.png)

动态帧编码

DST(动态段尾部序列)：仅用于动态帧传输， 用来表明动态段中传输时隙动作点的精确时间点，并防止接受段过早的检测到网络空闲状态。由一个长度可变的低电平和一位高电平组成。

将这些序列与有效位（从最大位 MSB 到最小位 LSB） 组装起来就是编码过程， 最终形成能够在网络传播的数据位流。

### 2.5 通讯 

FlexRay总线的通讯由通讯周期（Communication Cycle）构成，从总线启动到停止都在不断重复该通讯周期。每个通讯周期具有相同的可配置时间间隔。

![pic_6eaa1f6b.png](https://mark.cuckooing.cn/pics/pic_6eaa1f6b.png)

通讯周期由4部分构成：静态段（Static Segment)、 动态段(Dynamic Segment)、 特征窗(Symbol Window） 和 网络空闲时间(Network Idle Time）

静态段：采用时分多址方式(TDMA Time Division Multiple Access)， 由固定的时隙数组成， 不可修改， 且所有时隙的大小一致。用来传输周期性的数据信息；

动态段：采用灵活的时分多址(FTDMA Flexible Time Division Multiple Access)， 由较小的时隙组成， 可根据需要扩展变动， 一般用于传输事件控制的消息

特征窗：用于传输特征符号。

符号有三种:

> 1.  冲突避免符号：用于冷启动节点的通讯启动
> 2.  测试符号：用于总线的测试
> 3.  唤醒符号：用于唤醒过程的初始化

网络空闲时间：用于时钟同步处理

## 三、总结 

FlexRay相对传统的LIN、CAN，还是要复杂得多，FlexRay主要用在汽车对安全性要求高的地方，这样也就要求总线处理的速度要很快  
![pic_8667ff7b.png](https://mark.cuckooing.cn/pics/pic_8667ff7b.png)

常用车载总线对比


[Link 1]: #_4
[FlexRay]: #FlexRay_10
[1.1 _FlexRay]: #11_FlexRay_11
[1.2 _FlexRay]: #12_FlexRay_17
[1.3 FlexRay]: #13_FlexRay_27
[FlexRay 1]: #FlexRay_48
[2.1 FlexRay]: #21_FlexRay_49
[2.2 FlexRay]: #22_FlexRay_62
[2.3]: #23__83
[2.3.1]: #231__87
[2.3.2]: #232__108
[2.3.3]: #233__112
[2.4]: #24__115
[2.4.1]: #241__122
[2.4.2]: #242__134
[2.5]: #25__142
[Link 2]: #_163
